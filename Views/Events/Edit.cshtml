@model CS478_EventPlannerProject.Models.Events
@{
    ViewData["Title"] = "Edit Event";
}

<h2>Edit Event</h2>
<link rel="stylesheet" href="~/css/events.css" />

<div class="row">
    <div class="col-md-8">
        <form asp-action="Edit" method="post" enctype="multipart/form-data">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <input type="hidden" asp-for="EventId" />
            <input type="hidden" asp-for="CreatorId" />

            <!-- Event Info Card -->
            <div class="card mb-3">
                <div class="card-header"><h5>Event Information</h5></div>
                <div class="card-body">
                    <div class="form-group">
                        <label asp-for="EventName" class="control-label">Event Name *</label>
                        <input asp-for="EventName" class="form-control" placeholder="Enter event name" />
                        <span asp-validation-for="EventName" class="text-danger"></span>
                    </div>
                    <div class="form-group mt-3">
                        <label asp-for="EventDescription" class="control-label">Description</label>
                        <textarea asp-for="EventDescription" class="form-control" rows="3" placeholder="Describe your event"></textarea>
                        <span asp-validation-for="EventDescription" class="text-danger"></span>
                    </div>
                    <div class="form-group mt-3">
                        <label asp-for="EventDetails" class="control-label">Additional Details</label>
                        <textarea asp-for="EventDetails" class="form-control" rows="2" placeholder="Any additional information"></textarea>
                        <span asp-validation-for="EventDetails" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <!-- Date & Time Card -->
            <div class="card mb-3">
                <div class="card-header"><h5>Date & Time</h5></div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label asp-for="StartDateTime" class="control-label">Start Date & Time *</label>
                            <input asp-for="StartDateTime" type="datetime-local" class="form-control" />
                            <span asp-validation-for="StartDateTime" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="EndDateTime" class="control-label">End Date & Time *</label>
                            <input asp-for="EndDateTime" type="datetime-local" class="form-control" />
                            <span asp-validation-for="EndDateTime" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label asp-for="TimeZone" class="control-label">Time Zone</label>
                            <input asp-for="TimeZone" class="form-control" placeholder="e.g., EST, PST, UTC" />
                            <span asp-validation-for="TimeZone" class="text-danger"></span>
                        </div>
                        <div class="col-md-6 form-check mt-4">
                            <input asp-for="IsAllDay" class="form-check-input" type="checkbox" />
                            <label asp-for="IsAllDay" class="form-check-label">All Day Event</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Location Card -->
            <div class="card mb-3">
                <div class="card-header"><h5>Location</h5></div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input asp-for="IsVirtual" class="form-check-input" type="checkbox" id="isVirtualCheck" />
                        <label asp-for="IsVirtual" class="form-check-label" for="isVirtualCheck">This is a virtual event</label>
                    </div>

                    <div id="physicalLocation">
                        <div class="form-group">
                            <label asp-for="VenueName" class="control-label">Venue Name</label>
                            <input asp-for="VenueName" class="form-control" placeholder="Enter venue name" />
                            <span asp-validation-for="VenueName" class="text-danger"></span>
                        </div>

                        <div class="form-group mt-3">
                            <label asp-for="Address" class="control-label">Street Address</label>
                            <div class="input-group">
                                <input asp-for="Address" class="form-control" id="addressInput" placeholder="Street address" />
                                <button type="button" class="btn btn-outline-secondary" onclick="getEventLocation()">
                                    <i class="bi bi-geo-alt-fill"></i> Use My Location
                                </button>
                            </div>
                            <span asp-validation-for="Address" class="text-danger"></span>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-6"><input asp-for="City" class="form-control" id="cityInput" /></div>
                            <div class="col-md-3"><input asp-for="State" class="form-control" id="stateInput" placeholder="e.g., CA" /></div>
                            <div class="col-md-3"><input asp-for="PostalCode" class="form-control" id="postalCodeInput" /></div>
                        </div>
                        <div class="form-group mt-3"><input asp-for="Country" class="form-control" id="countryInput" placeholder="e.g., United States" /></div>
                    </div>

                    <div id="virtualLocation" style="display: none;">
                        <div class="form-group">
                            <label asp-for="VirtualMeetingUrl" class="control-label">Virtual Meeting URL</label>
                            <input asp-for="VirtualMeetingUrl" type="url" class="form-control" placeholder="https://zoom.us/j/123456789" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5>Event Settings</h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label asp-for="MaxAttendees" class="control-label">Maximum Attendees</label>
                        <input asp-for="MaxAttendees" type="number" class="form-control" placeholder="Leave blank for unlimited" />
                        <span asp-validation-for="MaxAttendees" class="text-danger"></span>
                        <small class="form-text text-muted">Maximum number of people who can attend (optional)</small>
                    </div>

                    <div class="form-check mt-3">
                        <input asp-for="IsPrivate" class="form-check-input" type="checkbox" />
                        <label asp-for="IsPrivate" class="form-check-label">Private Event</label>
                        <small class="form-text text-muted d-block">Only invited users can see and join this event</small>
                    </div>

                    <div class="form-check mt-3">
                        <input asp-for="RequiresApproval" class="form-check-input" type="checkbox" />
                        <label asp-for="RequiresApproval" class="form-check-label">Require Approval</label>
                        <small class="form-text text-muted d-block">Attendees must be approved before joining</small>
                    </div>

                    <div class="form-check mt-3">
                        <input asp-for="AllowGuestList" class="form-check-input" type="checkbox" />
                        <label asp-for="AllowGuestList" class="form-check-label">Allow Guest List</label>
                        <small class="form-text text-muted d-block">Show the list of attendees to everyone</small>
                    </div>
                </div>
            </div>

            <!-- Appearance Section -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5>Appearance</h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label asp-for="BannerImageFile" class="control-label">Banner Image</label>
                        <input asp-for="BannerImageFile" type="file" class="form-control" accept="image/*" data-val="false" />
                        <span asp-validation-for="BannerImageFile" class="text-danger"></span>
                        <small class="form-text text-muted">Upload an image for your event banner (JPG, PNG, GIF)</small>

                        @if (!string.IsNullOrEmpty(Model.BannerImageUrl))
                        {
                            <div class="mt-2">
                                <img src="@Model.BannerImageUrl" alt="Current Banner" style="max-width: 200px; max-height: 150px; border-radius: 8px;" />
                                <p class="text-muted">Current banner image</p>
                            </div>
                        }
                    </div>

                    <div class="form-group mt-3">
                        <label asp-for="ThemeId" class="control-label">Theme</label>
                        <input asp-for="ThemeId" type="number" class="form-control" />
                        <span asp-validation-for="ThemeId" class="text-danger"></span>
                        <small class="form-text text-muted">Select a theme ID (optional)</small>
                    </div>

                    <!--Enhanced CSS Editor-->
                    <div class="form-group mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label asp-for="CustomCss" class="control-label mb-0">Custom CSS Styles</label>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-secondary" onlick="toggleCssPreview()">
                                    <i class="fas fa-eye"></i> Toggle Preview
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="formatCss()">
                                    <i class="fas fa-magic"></i> Format
                                </button>
                                <button type="button" class="btn btn-outline-danger" onclick="validateCss()">
                                    <i class="fas fa-check-circle"></i> Validate
                                </button>
                            </div>
                        </div>
                        <div class="css-editor-container">
                            <!--Templates Dropdown-->
                            <div class="mb-2">
                                <select class="form-select form-select-sm" id="cssTemplateSelect" onchange="applyCssTemplate(this.value)">
                                    <option value="">-- Choose a template (optional) --</option>
                                    <option value="modern">Modern Minimal</option>
                                    <option value="vibrant">Vibrant Colors</option>
                                    <option value="elegant">Elegant Dark</option>
                                    <option value="playful">Playful Fun</option>
                                </select>
                            </div>
                            <!--CSS Editor Textarea-->
                            <textarea asp-for="CustomCss"
                                      id="customCssEditor"
                                      class="form-control font-monospace"
                                      rows="12"
                                      placeholder="/* Enter your custom CSS here */
                                                     /* Available selectors:
                                                        .event-header { }
                                                        .event-title { }
                                                        .event-description { }
                                                        .event-date { }
                                                        .event-location { }
                                                        .btn-rsvp { }
                                                     */"
                                      style="font-size: 13px; background-color: #f8f9fa;"></textarea>
                            <span asp-validation-for="CustomCss" class="text-danger"></span>
                            <div class="d-flex justify-content-between align-items-center mt-1">
                                <small class="form-text text-muted">Customize your event page appearance with CSS</small>
                                <small class="text-muted" id="cssCharCount">0 / 10000 characters</small>
                            </div>
                            <!--Validation Alert-->
                            <div class="alert alert-danger mt-2" id="cssValidationAlert" style="display: none;">
                                <strong> Validation Error:</strong> <span id="cssValidationMessage"></span>
                            </div>
                            <div class="alert alert-success mt-2" id="cssValidationSuccess" style="display: none;">
                                <strong></strong> CSS looks good! Safe to save.
                            </div>
                        </div>
                        <!--Preview Panel (toggleable)-->
                        <div class="card mt-3" id="cssPreviewPanel" style="display: none;">
                            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-desktop"></i> Live Preview</span>
                                <button type="button" class="btn btn-sm btn-light" onclick="refreshCssPreview()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                            <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                <div id="cssPreviewContent">
                                    <!--Preview content will be injected here-->
                                    <div class="event-header" style="padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; margin-bottom: 20px;">
                                        <h1 class="event-title" style="color: white; margin-bottom: 10px;">@Model.EventName</h1>
                                        <p class="event-date" style="color: rgba(255,255,255,0.9);">@Model.StartDateTime.ToString("MMMM dd, yyyy 'at' h:mm tt")</p>
                                    </div>
                                    <div style="padding: 20px;">
                                        <div class="event-description" style="margin-bottom: 20px;">
                                            <h2 style="color: #2c3e50; margin-bottom: 10px;">About This Event</h2>
                                            <p style="color: #555;">@(Model.EventDescription ?? "This is a sample event description to show how your custom CSS will look.")</p>
                                        </div>
                                        <button class="btn-rsvp" style="background: #3498db; color: white; padding: 10px 25px; border: none; border-radius: 6px;">
                                            RSVP Now
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!--Help Text-->
                        <div class="card mt-2" style="background-color: #f8f9fa; border: none;">
                            <div class="card-body py-2">
                                <small class="text-muted">
                                    <strong> Tips:</strong>
                                    Use templates for inspiration.
                                    Target classes like <code>.event-header</code>, <code>.event-title</code>, <code>.event-description</code>, etc.
                                    Avoid using <code>!important</code> unless necessary.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <a asp-action="Details" asp-route-id="@Model.EventId" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle between physical and virtual location fields
        document.getElementById('isVirtualCheck').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('physicalLocation').style.display = 'none';
                document.getElementById('virtualLocation').style.display = 'block';
            } else {
                document.getElementById('physicalLocation').style.display = 'block';
                document.getElementById('virtualLocation').style.display = 'none';
            }
        });
    // Geolocation
            window.getEventLocation = function() {
                const addressInput = document.getElementById('addressInput');
                const cityInput = document.getElementById('cityInput');
                const stateInput = document.getElementById('stateInput');
                const postalCodeInput = document.getElementById('postalCodeInput');
                const countryInput = document.getElementById('countryInput');

                if (!navigator.geolocation) {
                    alert("Geolocation not supported by your browser.");
                    return;
                }

                // Show loading state
                addressInput.value = "Getting location...";

                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;

                        // Use OpenStreetMap's Nominatim API for reverse geocoding
                        fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`)
                            .then(response => response.json())
                            .then(data => {
                                console.log('Location data received:', data);
                                const address = data.address;

                                // Fill in address fields
                                const street = `${address.house_number || ''} ${address.road || ''}`.trim();
                                addressInput.value = street || '';

                                // Try multiple city fields
                                const city = address.city
                                          || address.town
                                          || address.village
                                          || address.municipality
                                          || address.county
                                          || address.hamlet
                                          || '';

                                cityInput.value = city;
                                stateInput.value = address.state || address.region || '';
                                postalCodeInput.value = address.postcode || '';
                                countryInput.value = address.country || '';

                                if (!city) {
                                    console.warn('Could not determine city. Full address data:', address);
                                }
                            })
                            .catch(error => {
                                console.error('Error getting location details:', error);
                                addressInput.value = '';
                                alert('Could not retrieve address details. Please enter manually.');
                            });
                    },
                    function(error) {
                        addressInput.value = '';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                alert("Location access denied. Please enable location permissions in your browser.");
                                break;
                            case error.POSITION_UNAVAILABLE:
                                alert("Location information is unavailable.");
                                break;
                            case error.TIMEOUT:
                                alert("The request to get your location timed out.");
                                break;
                            default:
                                alert("An unknown error occurred.");
                                break;
                        }
                    }
                );
            }
    

        const cssEditor = document.getElementById('customCssEditor');
        const previewPanel = document.getElementById('cssPreviewPanel');
        const previewContent = document.getElementById('cssPreviewContent');
        const MAX_CSS_LENGTH = 10000;
        let previewStyleElement = null;

        function applyPreview() {
            if(previewStyleElement) previewStyleElement.remove();
            previewStyleElement = document.createElement('style');
            previewStyleElement.textContent = cssEditor.value;
            previewContent.appendChild(previewStyleElement);
        }

        function validateCss() {
            const css = cssEditor.value;
            const invalid = [/javascript:/i,/expression\(/i,/url\(data:/i,/<script/i,/on(click|load|error|mouse)/i];
            for(const p of invalid) if(p.test(css)) { alert('Unsafe CSS detected'); return false; }
            if(css.length>MAX_CSS_LENGTH){ alert('CSS too long'); return false; }
            return true;
        }

        if(cssEditor) cssEditor.addEventListener('input', applyPreview);

        // Form submission
        document.querySelector('form').addEventListener('submit', function(e){
            if(cssEditor && cssEditor.value.trim() && !validateCss()){
                e.preventDefault();
            }
        });
    });
</script>

@model CS478_EventPlannerProject.Models.Events
@{
    ViewData["Title"] = "Create Event";
    var venues = ViewBag.Venues as List<CS478_EventPlannerProject.Models.Venue>;
}

<link rel="stylesheet" href="~/css/events.css" />

<style>
    /* CSS Editor Styling */
    .css-editor-container {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 15px;
        background: white;
    }

    #customCssEditor {
        font-family: 'Courier New', Consolas, monospace;
        font-size: 13px;
        line-height: 1.5;
        border: 1px solid #ced4da;
        border-radius: 4px;
        resize: vertical;
    }

        #customCssEditor:focus {
            background-color: white;
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

    #cssPreviewContent {
        background: white;
        border-radius: 8px;
    }

    .btn-group-sm .btn-group-sm {
        font-size: 0.875rem;
        padding: 0.25rem 0.5rem;
    }
</style>

<h2>Create New Event</h2>

<div class="row">
    <div class="col-md-8">
        <form asp-action="Create" method="post" enctype="multipart/form-data" id="eventForm">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <!-- Hidden Inputs -->
            <input type="hidden" name="selectedVenueId" id="selectedVenueId" />
            <input type="hidden" name="selectedTimeSlot" id="selectedTimeSlot" />
            <input type="hidden" name="SelectedBanner" id="selectedBannerInput" value="" />

            <!-- BASIC INFORMATION -->
            <div class="card mb-3">
                <div class="card-header"><h5>Event Information</h5></div>
                <div class="card-body">
                    <div class="form-group">
                        <label asp-for="EventName" class="control-label">Event Name *</label>
                        <input asp-for="EventName" class="form-control" placeholder="Enter event name" />
                        <span asp-validation-for="EventName" class="text-danger"></span>
                    </div>

                    <div class="form-group mt-3">
                        <label asp-for="EventDescription" class="control-label">Description</label>
                        <textarea asp-for="EventDescription" class="form-control" rows="3" placeholder="Describe your event"></textarea>
                        <span asp-validation-for="EventDescription" class="text-danger"></span>
                    </div>

                    <div class="form-group mt-3">
                        <label asp-for="EventDetails" class="control-label">Additional Details</label>
                        <textarea asp-for="EventDetails" class="form-control" rows="2" placeholder="Any additional information"></textarea>
                        <span asp-validation-for="EventDetails" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <!-- DATE & TIME -->
            <div class="card mb-3">
                <div class="card-header"><h5>Date & Time</h5></div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="StartDateTime" class="control-label">Start Date & Time *</label>
                                <input asp-for="StartDateTime" type="datetime-local" class="form-control" />
                                <span asp-validation-for="StartDateTime" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="EndDateTime" class="control-label">End Date & Time *</label>
                                <input asp-for="EndDateTime" type="datetime-local" class="form-control" />
                                <span asp-validation-for="EndDateTime" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="TimeZone" class="control-label">Time Zone</label>
                                <input asp-for="TimeZone" class="form-control" placeholder="e.g., EST, PST, UTC" />
                                <span asp-validation-for="TimeZone" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mt-4">
                                <input asp-for="IsAllDay" class="form-check-input" type="checkbox" />
                                <label asp-for="IsAllDay" class="form-check-label">All Day Event</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- LOCATION (Venues / Virtual) -->
            <div class="card mb-3">
                <div class="card-header"><h5>Location</h5></div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input asp-for="IsVirtual" class="form-check-input" type="checkbox" id="isVirtualCheck" />
                        <label asp-for="IsVirtual" class="form-check-label" for="isVirtualCheck">
                            This is a virtual event
                        </label>
                    </div>

                    <!-- Venue Selection -->
                    <div id="venueSelection" style="display: block;">
                        <div class="alert alert-info">
                            <strong>Select a Venue:</strong> Choose from our available venues below or enter a custom location
                        </div>

                        <!-- Option to use custom location -->
                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="toggleCustomLocationBtn">
                                <i class="bi bi-pencil"></i> Enter Custom Location Instead
                            </button>
                        </div>

                        <div class="venue-grid" id="venueGrid">
                            @if (venues != null && venues.Any())
                            {
                                foreach (var venue in venues)
                                {
                                    <div class="venue-card" data-venue-id="@venue.VenueId">
                                        <div class="venue-card-header">
                                            <h6>@venue.VenueName</h6>
                                            <small class="text-muted">@venue.VenueType</small>
                                        </div>
                                        <div class="venue-card-body">
                                            <p><strong>Capacity:</strong> @venue.Capacity people</p>
                                            <p><strong>Location:</strong> @venue.Address, @venue.City</p>
                                            <p><strong>Amenities:</strong> @venue.Amenities</p>
                                            <button type="button" class="btn btn-sm btn-outline-primary select-venue-btn" data-venue-id="@venue.VenueId">
                                                Select Venue
                                            </button>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="alert alert-warning">
                                    No venues available. Please contact administrator.
                                </div>
                            }
                        </div>

                        <!-- Custom Location Entry (hidden by default) -->
                        <div id="customLocationEntry" style="display: none;" class="mt-4">
                            <div class="form-group">
                                <label asp-for="VenueName" class="control-label">Venue Name</label>
                                <input asp-for="VenueName" class="form-control" placeholder="Enter venue name" />
                                <span asp-validation-for="VenueName" class="text-danger"></span>
                            </div>

                            <div class="form-group mt-3">
                                <label asp-for="Address" class="control-label">Street Address</label>
                                <div class="input-group">
                                    <input asp-for="Address" class="form-control" id="addressInput" placeholder="Street address" />
                                    <button type="button" class="btn btn-outline-secondary" onclick="getEventLocation()">
                                        <i class="bi bi-geo-alt-fill"></i> Use My Location
                                    </button>
                                </div>
                                <span asp-validation-for="Address" class="text-danger"></span>
                            </div>

                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <input asp-for="City" class="form-control" id="cityInput" placeholder="City" />
                                </div>
                                <div class="col-md-4">
                                    <input asp-for="State" class="form-control" id="stateInput" placeholder="State" />
                                </div>
                                <div class="col-md-4">
                                    <input asp-for="PostalCode" class="form-control" id="postalCodeInput" placeholder="Postal Code" />
                                </div>
                            </div>

                            <div class="form-group mt-3">
                                <input asp-for="Country" class="form-control" id="countryInput" placeholder="Country" />
                            </div>

                            <div class="mt-3">
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="backToVenuesBtn">
                                    <i class="bi bi-arrow-left"></i> Back to Venue Selection
                                </button>
                            </div>
                        </div>

                        <!-- Selected Venue Details -->
                        <div id="selectedVenueDetails" style="display: none;" class="mt-4">
                            <div class="alert alert-success">
                                <h6>Selected Venue: <span id="selectedVenueName"></span></h6>
                                <p id="selectedVenueInfo"></p>
                                <button type="button" class="btn btn-sm btn-secondary" id="changeVenueBtn">Change Venue</button>
                            </div>

                            <!-- Time Slot Selection -->
                            <div class="form-group">
                                <label class="control-label">Available Time Slots</label>
                                <div id="timeSlotContainer" class="time-slot-container"></div>
                                <small class="text-muted">Select an available time slot for your event</small>
                            </div>
                        </div>
                    </div>

                    <!-- Virtual Location -->
                    <div id="virtualLocation" style="display: none;">
                        <div class="form-group">
                            <label asp-for="VirtualMeetingUrl" class="control-label">Virtual Meeting URL</label>
                            <input asp-for="VirtualMeetingUrl" type="url" class="form-control" placeholder="https://zoom.us/j/123456789" />
                            <span asp-validation-for="VirtualMeetingUrl" class="text-danger"></span>
                            <small class="form-text text-muted">Enter the link to your Zoom, Teams, or other virtual meeting</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SETTINGS -->
            <div class="card mb-3">
                <div class="card-header"><h5>Event Settings</h5></div>
                <div class="card-body">
                    <div class="form-group">
                        <label asp-for="MaxAttendees" class="control-label">Maximum Attendees</label>
                        <input asp-for="MaxAttendees" type="number" class="form-control" placeholder="Leave blank for unlimited" />
                        <span asp-validation-for="MaxAttendees" class="text-danger"></span>
                        <small class="form-text text-muted">Maximum number of people who can attend (optional)</small>
                    </div>

                    <div class="form-check mt-3">
                        <input asp-for="IsPrivate" class="form-check-input" type="checkbox" />
                        <label asp-for="IsPrivate" class="form-check-label">Private Event</label>
                        <small class="form-text text-muted d-block">Only invited users can see and join this event</small>
                    </div>

                    <div class="form-check mt-3">
                        <input asp-for="RequiresApproval" class="form-check-input" type="checkbox" />
                        <label asp-for="RequiresApproval" class="form-check-label">Require Approval</label>
                        <small class="form-text text-muted d-block">Attendees must be approved before joining</small>
                    </div>

                    <div class="form-check mt-3">
                        <input asp-for="AllowGuestList" class="form-check-input" type="checkbox" />
                        <label asp-for="AllowGuestList" class="form-check-label">Allow Guest List</label>
                        <small class="form-text text-muted d-block">Show the list of attendees to everyone</small>
                    </div>
                </div>
            </div>

            <!-- APPEARANCE SECTION -->
            <div class="card mb-3">
                <div class="card-header"><h5>Appearance</h5></div>
                <div class="card-body">
                    <!-- Banner Selection -->
                    <div class="form-group">
                        <label class="control-label">Banner Image</label>
                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="showBannersBtn">
                                <i class="bi bi-images"></i> Choose from Default Banners
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm d-none" id="hideBannersBtn">
                                <i class="bi bi-x"></i> Hide Banners
                            </button>
                        </div>
                        <div id="bannerGallery" class="mb-3" style="display: none;">
                            <p class="text-muted mb-2">Select a default banner:</p>
                            <div id="bannerContainer">
                                <div class="text-center text-muted py-3">
                                    <span class="spinner-border spinner-border-sm me-2"></span> Loading banners...
                                </div>
                            </div>
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Or upload a custom banner:</label>
                            <input asp-for="BannerImageFile" type="file" class="form-control" id="customBannerUpload" accept="image/*" data-val="false" />
                            <span asp-validation-for="BannerImageFile" class="text-danger"></span>
                            <small class="form-text text-muted">Upload a custom banner image (JPG, PNG, GIF - Recommended: 1200x400px)</small>
                        </div>
                    </div>

                    <!-- Theme -->
                    <div class="form-group mt-3">
                        <label asp-for="ThemeId" class="control-label">Theme</label>
                        <input asp-for="ThemeId" type="number" class="form-control" />
                        <span asp-validation-for="ThemeId" class="text-danger"></span>
                        <small class="form-text text-muted">Select a theme ID (optional)</small>
                    </div>

                    <!-- CSS Editor -->
                    <div class="form-group mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label asp-for="CustomCss" class="control-label mb-0">Custom CSS Styles</label>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-secondary" onclick="toggleCssPreview()"><i class="fas fa-eye"></i> Toggle Preview</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="formatCss()"><i class="fas fa-magic"></i> Format</button>
                                <button type="button" class="btn btn-outline-danger" onclick="validateCss()"><i class="fas fa-check-circle"></i> Validate</button>
                            </div>
                        </div>
                        <div class="css-editor-container">
                            <div class="mb-2">
                                <select class="form-select form-select-sm" id="cssTemplateSelect" onchange="applyCssTemplate(this.value)">
                                    <option value="">-- Choose a template (optional) --</option>
                                    <option value="modern">Modern Minimal</option>
                                    <option value="vibrant">Vibrant Colors</option>
                                    <option value="elegant">Elegant Dark</option>
                                    <option value="playful">Playful Fun</option>
                                </select>
                            </div>
                            <textarea asp-for="CustomCss" id="customCssEditor" class="form-control font-monospace" rows="12"
                                      placeholder="/* Enter your custom CSS here */" style="font-size: 13px; background-color: #f8f9fa;"></textarea>
                            <span asp-validation-for="CustomCss" class="text-danger"></span>
                            <div class="d-flex justify-content-between align-items-center mt-1">
                                <small class="form-text text-muted">Customize your event page appearance with CSS</small>
                                <small class="text-muted" id="cssCharCount">0 / 10000 characters</small>
                            </div>
                            <div class="alert alert-danger mt-2" id="cssValidationAlert" style="display: none;">
                                <strong>Validation Error:</strong> <span id="cssValidationMessage"></span>
                            </div>
                            <div class="alert alert-success mt-2" id="cssValidationSuccess" style="display: none;">
                                <strong>✓</strong> CSS looks good! Safe to save.
                            </div>
                        </div>

                        <!-- Preview Panel -->
                        <div class="card mt-3" id="cssPreviewPanel" style="display: none;">
                            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-desktop"></i> Live Preview</span>
                                <button type="button" class="btn btn-sm btn-light" onclick="refreshCssPreview()"><i class="fas fa-sync-alt"></i> Refresh</button>
                            </div>
                            <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                <div id="cssPreviewContent">
                                    <div class="event-header" style="padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; margin-bottom: 20px;">
                                        <h1 class="event-title" style="color: white; margin-bottom: 10px;">@(Model.EventName ?? "Sample Event Name")</h1>
                                        <p class="event-date" style="color: rgba(255,255,255,0.9);">@Model.StartDateTime.ToString("MMMM dd, yyyy 'at' h:mm tt")</p>
                                    </div>
                                    <div style="padding: 20px;">
                                        <div class="event-description" style="margin-bottom: 20px;">
                                            <h2 style="color: #2c3e50; margin-bottom: 10px;">About This Event</h2>
                                            <p style="color: #555;">@(Model.EventDescription ?? "This is a sample event description to show how your custom CSS will look.")</p>
                                        </div>
                                        <button class="btn-rsvp" style="background: #3498db; color: white; padding: 10px 25px; border: none; border-radius: 6px;">RSVP Now</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-2" style="background-color: #f8f9fa; border: none;">
                            <div class="card-body py-2">
                                <small class="text-muted">
                                    <strong>💡 Tips:</strong> Use templates for inspiration. Target classes like <code>.event-header</code>, <code>.event-title</code>, <code>.event-description</code>. Avoid <code>!important</code> unless necessary.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SUBMIT -->
            <div class="form-group">
                <button type="submit" class="btn btn-primary">Create Event</button>
                <a asp-action="Index" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>

@section Scripts{
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle between physical and virtual location fields
        document.getElementById('isVirtualCheck').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('physicalLocation').style.display = 'none';
                document.getElementById('virtualLocation').style.display = 'block';
            } else {
                document.getElementById('physicalLocation').style.display = 'block';
                document.getElementById('virtualLocation').style.display = 'none';
            }
        });

        // Toggle between venue selection and custom location entry
        const toggleCustomLocationBtn = document.getElementById('toggleCustomLocationBtn');
        const backToVenuesBtn = document.getElementById('backToVenuesBtn');
        const venueGrid = document.getElementById('venueGrid');
        const customLocationEntry = document.getElementById('customLocationEntry');
        const selectedVenueDetails = document.getElementById('selectedVenueDetails');

        if (toggleCustomLocationBtn) {
            toggleCustomLocationBtn.addEventListener('click', function() {
                venueGrid.style.display = 'none';
                toggleCustomLocationBtn.style.display = 'none';
                selectedVenueDetails.style.display = 'none';
                customLocationEntry.style.display = 'block';
                // Clear selected venue
                document.getElementById('selectedVenueId').value = '';
            });
        }

        if (backToVenuesBtn) {
            backToVenuesBtn.addEventListener('click', function() {
                customLocationEntry.style.display = 'none';
                venueGrid.style.display = 'block';
                toggleCustomLocationBtn.style.display = 'block';
            });
        }

        // Get event location from geolocation
        function getEventLocation() {
            const addressInput = document.getElementById('addressInput');
            const cityInput = document.getElementById('cityInput');
            const stateInput = document.getElementById('stateInput');
            const postalCodeInput = document.getElementById('postalCodeInput');
            const countryInput = document.getElementById('countryInput');

            if (!navigator.geolocation) {
                alert("Geolocation is not supported by your browser.");
                return;
            }

            // Show loading state
            addressInput.value = "Getting location...";

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    // Use OpenStreetMap's Nominatim API for reverse geocoding
                    fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`)
                        .then(response => response.json())
                        .then(data => {
                            console.log('Location data received:', data);
                            const address = data.address;

                            // Fill in address fields
                            const street = `${address.house_number || ''} ${address.road || ''}`.trim();
                            addressInput.value = street || '';

                            // Try multiple city fields
                            const city = address.city
                                      || address.town
                                      || address.village
                                      || address.municipality
                                      || address.county
                                      || address.hamlet
                                      || '';

                            cityInput.value = city;
                            stateInput.value = address.state || address.region || '';
                            postalCodeInput.value = address.postcode || '';
                            countryInput.value = address.country || '';

                            if (!city) {
                                console.warn('Could not determine city. Full address data:', address);
                            }
                        })
                        .catch(error => {
                            console.error('Error getting location details:', error);
                            addressInput.value = '';
                            alert('Could not retrieve address details. Please enter manually.');
                        });
                },
                function(error) {
                    addressInput.value = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            alert("Location access denied. Please enable location permissions in your browser.");
                            break;
                        case error.POSITION_UNAVAILABLE:
                            alert("Location information is unavailable.");
                            break;
                        case error.TIMEOUT:
                            alert("The request to get your location timed out.");
                            break;
                        default:
                            alert("An unknown error occurred.");
                            break;
                    }
                }
            );
        }

        // Make getEventLocation available globally for onclick handler
        window.getEventLocation = getEventLocation;
    });

    const cssEditor = document.getElementById('customCssEditor');
    const charCount = document.getElementById('cssCharCount');
    const previewPanel = document.getElementById('cssPreviewPanel');
    const previewContent = document.getElementById('cssPreviewContent');
    const validationAlert = document.getElementById('cssValidationAlert');
    const validationSuccess = document.getElementById('cssValidationSuccess');
    const validationMessage = document.getElementById('cssValidationMessage');
    const MAX_CSS_LENGTH = 10000;
    let previewStyleElement = null;

    const cssTemplates = {
            modern: `/* Modern Minimal Theme */
    .event-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        border-radius: 12px !important;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2) !important;
    }

    .event-title {
        font-size: 2.5em !important;
        font-weight: 700 !important;
        letter-spacing: -0.5px !important;
    }

    .event-description, .event-location {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }

    .btn-rsvp {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        transition: all 0.3s ease;
    }

    .btn-rsvp:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }`,

            vibrant: `/* Vibrant Colors Theme */
    .event-header {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
        padding: 40px !important;
    }

    .event-title {
        font-size: 3em !important;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2) !important;
    }

    .event-description h2, .event-location h3 {
        color: #f5576c !important;
        border-bottom: 3px solid #f093fb;
        padding-bottom: 10px;
    }

    .btn-rsvp {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
        font-weight: bold !important;
        text-transform: uppercase !important;
    }`,

            elegant: `/* Elegant Dark Theme */
    .event-header {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%) !important;
        border-bottom: 3px solid #0f3460 !important;
    }

    .event-title {
        font-family: Georgia, serif !important;
        font-size: 2.8em !important;
        color: #eee !important;
    }

    .event-date {
        color: #94a3b8 !important;
        font-style: italic !important;
    }

    .btn-rsvp {
        background: #0f3460 !important;
        border: 2px solid #16213e !important;
    }`,

            playful: `/* Playful Fun Theme */
    .event-header {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%) !important;
        border-radius: 20px !important;
        border: 5px dashed #ff8c69 !important;
    }

    .event-title {
        color: #ff6b6b !important;
        transform: rotate(-2deg);
    }

    .event-description, .event-location {
        background: #fff5e1;
        border-radius: 15px;
        padding: 20px;
        border: 3px solid #ffd93d;
    }

    .btn-rsvp {
        background: #ff6b6b !important;
        border-radius: 25px !important;
        font-weight: bold !important;
    }`
    };
            // Update character count on input
    if (cssEditor) {
        cssEditor.addEventListener('input', function() {
            updateCharCount();
            if (previewPanel.style.display !== 'none') {
                applyPreviewStyles();
            }
        });

        // Initialize character count
        updateCharCount();
    }

    function updateCharCount() {
        const length = cssEditor.value.length;
        charCount.textContent = `${length} / ${MAX_CSS_LENGTH} characters`;

        if (length > MAX_CSS_LENGTH) {
            charCount.classList.add('text-danger');
        } else {
            charCount.classList.remove('text-danger');
        }
    }

    function toggleCssPreview() {
        if (previewPanel.style.display === 'none') {
            previewPanel.style.display = 'block';
            applyCssToPreview();
        } else {
            previewPanel.style.display = 'none';
        }
    }

    function applyPreviewStyles() {
        // Remove existing preview style
        if (previewStyleElement) {
            previewStyleElement.remove();
        }

        // Create new style element
        previewStyleElement = document.createElement('style');
        previewStyleElement.textContent = cssEditor.value;
        previewContent.appendChild(previewStyleElement);
    }

    function refreshCssPreview() {
        applyPreviewStyles();
    }

    function formatCss() {
        let css = cssEditor.value;

        // Basic CSS formatting
        css = css.replace(/\s*{\s*/g, ' {\n    ');
        css = css.replace(/;\s*/g, ';\n    ');
        css = css.replace(/\s*}\s*/g, '\n}\n\n');
        css = css.replace(/\n\s*\n\s*\n/g, '\n\n');
        css = css.trim();

        cssEditor.value = css;
        updateCharCount();

        if (previewPanel.style.display !== 'none') {
            applyPreviewStyles();
        }
    }

    function validateCss() {
        const css = cssEditor.value;
        // Hide previous alerts
        validationAlert.style.display = 'none';
        validationSuccess.style.display = 'none';

        // Check length
        if (css.length > MAX_CSS_LENGTH) {
            showValidationError(`CSS is too long (${css.length} characters). Maximum allowed is ${MAX_CSS_LENGTH}.`);
            return false;
        }

        // Check for dangerous patterns
        const dangerousPatterns = [
            { pattern: /javascript:/gi, name: 'javascript:' },
            { pattern: /expression\(/gi, name: 'expression()' },
            { pattern: /url\(data:/gi, name: 'data URLs' },
            { pattern: /<script/gi, name: '<script>' },
            { pattern: /on(click|load|error|mouse)/gi, name: 'inline event handlers' }
        ];
        for (let check of dangerousPatterns) {
            if (check.pattern.test(css)) {
                showValidationError(`Potentially unsafe content detected: ${check.name}`);
                return false;
            }
        }
        // Show success
        validationSuccess.style.display = 'block';
        setTimeout(() => {
            validationSuccess.style.display = 'none';
        }, 3000);

        return true;
    }

    function showValidationError(message) {
        validationMessage.textContent = message;
        validationAlert.style.display = 'block';

        // Scroll to alert
        validationAlert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function applyCssTemplate(templateName) {
        if (templateName && cssTemplates[templateName]) {
            if (cssEditor.value && !confirm('This will replace your current CSS. Continue?')) {
                document.getElementById('cssTemplateSelect').value = '';
                return;
            }

            cssEditor.value = cssTemplates[templateName];
            updateCharCount();

            if (previewPanel.style.display !== 'none') {
                applyPreviewStyles();
            }
            // Reset dropdown
            setTimeout(() => {
                document.getElementById('cssTemplateSelect').value = '';
            }, 100);
        }
    }

    // Validate before form submission
    document.querySelector('form').addEventListener('submit', function(e) {
        if (cssEditor.value.trim()) {
            if (!validateCss()) {
                e.preventDefault();
                alert('Please fix CSS validation errors before saving.');
                return false;
            }
        }
    });
    </script>
}

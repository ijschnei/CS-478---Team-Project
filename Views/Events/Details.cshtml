@model CS478_EventPlannerProject.Models.Events
@using Microsoft.AspNetCore.Identity
@inject UserManager<CS478_EventPlannerProject.Models.Users> UserManager
@{
    ViewData["Title"] = Model.EventName;
    var currentUserId = UserManager.GetUserId(User);
    var isCreator = Model.CreatorId == currentUserId;
    var isAttendee = Model.Attendees.Any(a => a.UserId == currentUserId && a.Status == "accepted");
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <!-- Event Header -->
            <div class="card mb-4">
                @if (!string.IsNullOrEmpty(Model.BannerImageUrl))
                {
                    <img src="@Model.BannerImageUrl" class="card-img-top" alt="@Model.EventName">
                }
                <div class="card-body">
                    <h1 class="card-title">@Model.EventName</h1>

                    @if (!string.IsNullOrEmpty(Model.EventDescription))
                    {
                        <p class="lead">@Model.EventDescription</p>
                    }

                    @if (!string.IsNullOrEmpty(Model.EventDetails))
                    {
                        <div class="mt-3">
                            <h5>Event Details</h5>
                            <p>@Model.EventDetails</p>
                        </div>
                    }

                    <!-- Action Buttons -->
                    <div class="mt-4">
                        @if (User.Identity.IsAuthenticated)
                        {
                            <!--Event Message -Added by Gage-Placeholder for testing need to tweak -->
                            @if(isCreator || isAttendee)
                            {
                                <a asp-controller="Messages"
                                    asp-action="EventGroupChat"
                                    asp-route-eventId="@Model.EventId"
                                    class="btn btn-primary">
                                     <i class="bi bi-chat-square-text"></i> Event Chat
                                </a>
                            }
                            @if (!isCreator && !isAttendee)
                            {
                                <form asp-action="Join" asp-route-id="@Model.EventId" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-success">
                                        <i class="bi bi-calendar-check"></i> Join Event
                                    </button>
                                </form>
                            }
                            <!--RSVP for attendees-->
                            @if (isAttendee)
                            {
                                var userAttendee = Model.Attendees.FirstOrDefault(a=>a.UserId == currentUserId);
                                @if(userAttendee != null)
                                {
                                    <span class="badge bg-success ms-2">
                                        <i class="bi bi-check-circle"></i> You're attending
                                    </span>
                                    
                                    <div class ="btn-group ms-2" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                            Change RSVP
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <form asp-action="UpdateRSVP" method="post" class="dropdown-item-form">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="eventId" value="@Model.EventId" />
                                                    <input type="hidden" name="status" value="tentative" />
                                                    <button type="submit" class="dropdown-item">
                                                        <i class="bi bi-question-circle"></i> Tentative
                                                    </button>
                                                </form>
                                            </li>
                                            <li>
                                                <form asp-action="UpdateRSVP" method="post" class="dropdown-item-form">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="eventId" value="@Model.EventId" />
                                                    <input type="hidden" name="status" value="declined" />
                                                    <button type="submit" class="dropdown-item">
                                                        <i class="bi bi-x-circle"></i> Decline
                                                    </button>
                                                </form>
                                            </li>
                                        </ul>
                                    </div>

                                }
                            }
                            @if (isCreator || User.IsInRole("Admin"))
                            {
                                <a asp-action="Edit" asp-route-id="@Model.EventId" class="btn btn-warning">
                                    <i class="bi bi-pencil"></i> Edit
                                </a>
                                <a asp-action="Delete" asp-route-id="@Model.EventId" class="btn btn-danger">
                                    <i class="bi bi-trash"></i> Delete
                                </a>
                                <a asp-action="Attendees" asp-route-id="@Model.EventId" class="btn btn-info">
                                    <i class="bi bi-people"></i> Manage Attendees
                                </a>
                            }
                        }
                        else
                        {
                            <a asp-area="Identity" asp-page="/Account/Login" class="btn btn-primary">
                                Login to Join Event
                            </a>
                        }

                        <a asp-action="Index" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Events
                        </a>
                    </div>
                </div>
            </div>

            <!-- Additional Information -->
            <div class="card">
                <div class="card-header">
                    <h5>Additional Information</h5>
                </div>
                <div class="card-body">
                    @if (Model.MaxAttendees.HasValue)
                    {
                        <div class="alert alert-info">
                            <strong>Capacity:</strong> Limited to @Model.MaxAttendees attendees
                        </div>
                    }

                    @if (Model.RequiresApproval)
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> This event requires approval to join
                        </div>
                    }

                    @if (Model.IsPrivate)
                    {
                        <div class="alert alert-secondary">
                            <i class="bi bi-lock"></i> This is a private event
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Date & Time Card -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-calendar-event"></i> Date & Time
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <strong>Start:</strong><br />
                        @if (Model.IsAllDay)
                        {
                            <span>@Model.StartDateTime.ToString("dddd, MMMM dd, yyyy") (All Day)</span>
                        }
                        else
                        {
                            <span>@Model.StartDateTime.ToString("dddd, MMMM dd, yyyy")</span>
                        
                            <br />
                            <span>@Model.StartDateTime.ToString("h:mm tt")</span>
                        }
                    </div>

                    <div class="mb-2">
                        <strong>End:</strong><br />
                        @if (Model.EndDateTime.HasValue)
                        {
                            @if (Model.IsAllDay)
                            {
                                <span>@Model.EndDateTime.Value.ToString("dddd, MMMM dd, yyyy") (All Day)</span>
                            }
                            else
                            {
                                <span>@Model.EndDateTime.Value.ToString("dddd, MMMM dd, yyyy")</span>
                        
                                <br />
                                <span>@Model.EndDateTime.Value.ToString("h:mm tt")</span>
                            }
                        }
                        else
                        {
                            <span class="text-muted">Not specified</span>
                        }
                    </div>

                    @if (!string.IsNullOrEmpty(Model.TimeZone))
                    {
                        <div class="mb-2">
                            <strong>Time Zone:</strong> @Model.TimeZone
                        </div>
                    }

                    @if (Model.EndDateTime.HasValue)
                    {
                        var duration = Model.EndDateTime.Value - Model.StartDateTime;
                        var durationText = "";
                        if (duration.TotalDays >= 1)
                        {
                            durationText = $"{duration.Days} day(s) {duration.Hours} hour(s)";
                        }
                        else if (duration.TotalHours >= 1)
                        {
                            durationText = $"{duration.Hours} hour(s) {duration.Minutes} min";
                        }
                        else
                        {
                            durationText = $"{duration.Minutes} minutes";
                        }
                        <div>
                            <strong>Duration:</strong> @durationText
                        </div>
                    }
                </div>
            </div>

            <!-- Location Card -->
            <div class="card mb-3">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-geo-alt"></i> Location
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.IsVirtual)
                    {
                        <p><strong>Virtual Event</strong></p>
                        @if (!string.IsNullOrEmpty(Model.VirtualMeetingUrl))
                        {
                            <a href="@Model.VirtualMeetingUrl" target="_blank" class="btn btn-sm btn-primary">
                                <i class="bi bi-camera-video"></i> Join Virtual Meeting
                            </a>
                        }
                        else
                        {
                            <p class="text-muted">Meeting link will be provided closer to the event.</p>
                        }
                    }
                    else
                    {
                        @if (!string.IsNullOrEmpty(Model.VenueName))
                        {
                            <p class="mb-1"><strong>@Model.VenueName</strong></p>
                        }

                        @if (!string.IsNullOrEmpty(Model.Address))
                        {
                            <p class="mb-1">@Model.Address</p>
                        }

                        @if (!string.IsNullOrEmpty(Model.City) || !string.IsNullOrEmpty(Model.State))
                        {
                            <p class="mb-1">@Model.City@(!string.IsNullOrEmpty(Model.City) && !string.IsNullOrEmpty(Model.State) ? ", " : "")@Model.State @Model.PostalCode</p>
                        }

                        @if (!string.IsNullOrEmpty(Model.Country))
                        {
                            <p class="mb-1">@Model.Country</p>
                        }

                        @if (!string.IsNullOrEmpty(Model.Address) && !string.IsNullOrEmpty(Model.City))
                        {
                            var mapQuery = Uri.EscapeDataString($"{Model.Address}, {Model.City}, {Model.State} {Model.PostalCode}");
                            <a href="https://www.google.com/maps/search/?api=1&query=@mapQuery" target="_blank" class="btn btn-sm btn-outline-primary mt-2">
                                <i class="bi bi-map"></i> View on Map
                            </a>
                        }
                    }
                </div>
            </div>

            <!-- Host Information Card -->
            @if (Model.Creator != null)
            {
                <div class="card mb-3">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-person"></i> Hosted By
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (Model.Creator.Profile != null)
                        {
                            <div class="d-flex align-items-center">
                                @if (!string.IsNullOrEmpty(Model.Creator.Profile.ProfileImageUrl))
                                {
                                    <img src="@Model.Creator.Profile.ProfileImageUrl"
                                         alt="@Model.Creator.Profile.FullName"
                                         class="rounded-circle me-3"
                                         width="50"
                                         height="50">
                                }
                                <div>
                                    <strong>@Model.Creator.Profile.FullName</strong><br />
                                    @if (!string.IsNullOrEmpty(Model.Creator.Profile.DisplayName))
                                    {
                                        <small class="text-muted">@@@Model.Creator.Profile.DisplayName</small>
                                    }
                                </div>
                            </div>

                            @if (!string.IsNullOrEmpty(Model.Creator.Profile.Bio))
                            {
                                <p class="mt-3 mb-0">@Model.Creator.Profile.Bio</p>
                            }
                            <!--Message Host Button-->
                            @if(User.Identity.IsAuthenticated && !isCreator)
                            {
                                <a asp-controller="Messages"
                                    asp-action="Compose"
                                    asp-route-receiverId="@Model.CreatorId"
                                    asp-route-eventId="@Model.EventId"
                                    class="btn btn-sm btn-outline-primary mt-3">
                                    <i class="bi bi-envelope"></i> Message Host
                                </a>
                            }
                        }
                        else
                        {
                            <p class="mb-0">@Model.Creator.Email</p>
                        }
                    </div>
                </div>
            }

            <!-- Attendees Card (if guest list is allowed) -->
            @if (Model.AllowGuestList)
            {
                <div class="card mb-3">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0">
                            <i class="bi bi-people"></i> Attendees
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (Model.MaxAttendees.HasValue)
                        {
                            <p class="mb-2">
                                <strong>Capacity:</strong> @Model.AttendeeCount / @Model.MaxAttendees
                            </p>
                            <div class="progress mb-3">
                                @{
                                    var percentage = Model.MaxAttendees.Value > 0
                                    ? (Model.AttendeeCount * 100.0 / Model.MaxAttendees.Value)
                                    : 0;
                                }
                                <div class="progress-bar @(percentage >= 90 ? "bg-danger" : percentage >= 70 ? "bg-warning" : "bg-success")"
                                     role="progressbar"
                                     style="width: @percentage%"
                                     aria-valuenow="@Model.AttendeeCount"
                                     aria-valuemin="0"
                                     aria-valuemax="@Model.MaxAttendees">
                                     @percentage.ToString("0")%
                                </div>
                            </div>
                        }
                        else
                        {
                            <p class="mb-2">
                                <strong>@Model.AttendeeCount</strong> attending
                            </p>
                        }

                        @if (Model.Attendees.Any(a=>a.Status == "accepted"))
                        {
                            <div class="mt-3">
                                <ul class="list-unstyled">
                                    @foreach (var attendee in Model.Attendees.Where(a=>a.Status =="accepted").Take(5))
                                    {
                                        <li class="mb-2 d-flex align-items-center">
                                            @if (!string.IsNullOrEmpty(attendee.User?.Profile?.ProfileImageUrl))
                                            {
                                                <img src="@attendee.User.Profile.ProfileImageUrl"
                                                    class="rounded-circle me-2"
                                                    width="30"
                                                    height="30"
                                                    alt="Profile" />
                                            }
                                            @if (attendee.User?.Profile != null)
                                            {
                                                <span>@attendee.User.Profile.FullName</span>
                                            }
                                            else
                                            {
                                                <span>@attendee.User?.Email</span>
                                            }
                                            @if (attendee.AttendeeType == "organizer")
                                            {
                                                <span class="badge bg-warning text-dark ms-2" style="font-size: 0.7rem;">Host</span>
                                            }
                                        </li>
                                    }
                                </ul>
                                @if (Model.AttendeeCount > 5)
                                {
                                    <small class="text-muted">and @(Model.AttendeeCount - 5) more...</small>
                                }
                            </div>
                        }   
                        else
                        {
                            <p class="text-muted">No confirmed attendees yet. Be the first to join!</p>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Auto-dismiss success/error messages
        setTimeout(function() {
            var alerts = document.querySelectorAll('.alert-dismissible');
            alerts.forEach(function(alert) {
                var bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            });
        }, 5000);
    </script>
}
@model IEnumerable<CS478_EventPlannerProject.Models.Messages>
@{
	ViewData["Title"] = "Conversation";
	var currentUserId = ViewBag.CurrentUserId as string;
	var conversationId = ViewBag.ConversationId as Guid?;
	var otherParticipant = ViewBag.OtherParticipant as CS478_EventPlannerProject.Models.Users;
}

<link rel="stylesheet" href="~/css/contacts.css" asp-append-version="true" />

<div class="container mt-4">
	<div class="row">
		<div class="col-md-12">
		<!--Conversation header-->
			<div class="card mb-3">
				<div class="card-body">
					<div class="d-flex justify-content-between align-items-center">
						<div>
							<a asp-action="Index" class="btn btn-sm btn-outline-secondary">
								<i class ="bi bi-arrow-left"></i> Back to Messages
							</a>
							<h4 class=d-"inline ms-3 mb-0">
								@if(otherParticipant != null)
								{
									@(otherParticipant.Profile?.FullName ?? otherParticipant.UserName ?? "Unknown User")
								}
								else
								{
									<text>Conversation</text>
								}
							</h4>
						</div>
						<div>
							@if (otherParticipant != null)
							{
								<a asp-action="Compose" asp-route-receiverId="@otherParticipant.Id" class="btn btn-sm btn-primary">
									<i class="bi bi-reply"></i> Reply
								</a>
							}
						</div>
					</div>
				</div>
			</div>
			@if (TempData["Success"] != null)
			{
				<div class="alert alert-success alert-dismissable fade show" role="alert">
					@TempData["Success"]
					<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
				</div>
			}
			@if (TempData["Error"] != null)
			{
				<div class="alert alert-success alert-dismissable fade show" role="alert">
					@TempData["Error"]
					<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
				</div>
			}
			<!--Messages-->
			<div class="card">
				<div class="card-body" style="max-height: 600px; overflow-y: auto;" id="messageContainer">
					@if (!Model.Any())
					{
						<div class="alert alert-info">
							<i class="bi bi-info-circle"></i> No messages in this conversation yet.
						</div>
					}
					else
					{
						@foreach (var message in Model)
						{
							var isCurrentUser = message.SenderId == currentUserId;
							var alignClass = isCurrentUser ? "justify-content-end" : "justify-content-start";
							var bgClass = isCurrentUser ? "bg-primary text-white" : "bg-light";
							var isEventInvitation = message.MessageType == "event_related" && message.RelatedEventId.HasValue;
							var hasJoinedEvent = isEventInvitation && (message.RelatedEvent?.Attendees.Any(a => a.UserId == currentUserId) ?? false);

							<div class="d-flex @alignClass mb-3">
								<div class="message-bubble @bgClass p-3 rounded" style="max-width: 70%;">
									@*Event Invitation Badge*@
									@if (isEventInvitation)
									{
										<div class="mb-2">
											<span class="badge @(isCurrentUser ? "bg-white text-primary" : "bg-info")">
												<i class="bi bi-calendar-event"></i> Event Invitation
											</span>
										</div>
									}
									@if (!string.IsNullOrEmpty(message.Subject))
									{
										<h6 class="mb-2 @(isCurrentUser ? "text-white-50" : "text-muted")">
											<strong>@message.Subject</strong>
										</h6>
									}
									<div class="message-content">
										@Html.Raw(System.Net.WebUtility.HtmlEncode(message.Content).Replace("\n", "<br/>"))
									</div>
									@*Event Details Section*@
									@if (message.RelatedEvent != null)
									{
										<div class="mt-3 pt-2 border-top @(isCurrentUser ? "border-white-50" : "border-secondary")">
											<div class="@(isCurrentUser ? "text-white" : "text-dark")">
												<div class="mb-2">
													<strong>
														<i class="bi bi-calendar-event"></i>
														@message.RelatedEvent.EventName
													</strong>
												</div>
												<small class="d-block @(isCurrentUser ? "text-white-75" : "text-muted")">
													<i class="bi bi-clock"></i>
													@message.RelatedEvent.StartDateTime.ToString("MMM dd, yyyy h:mm tt")
												</small>
												<small class ="d-block @(isCurrentUser ? "text-white-75" : "text-muted")">
													<i class="bi bi-geo-alt"></i>
													@message.RelatedEvent.FormattedLocation
												</small>
											</div>
											@*Action Buttons for Recipient*@
											@if(isEventInvitation && !isCurrentUser)
											{
												<div class="mt-3 d-flex gap-2 flex-wrap">
													@if (!hasJoinedEvent)
													{
														<form asp-controller="EventInvitations"
															asp-action="Accept"
															asp-route-messageId="@message.Id"
															method="post"
															class="d-inline"
															onsubmit="return confirm('Accept this event invitation?');">
														@Html.AntiForgeryToken()
														<button type = "submit" class="btn btn-success btn-sm">
															<i class="bi bi-check-circle"></i> Accept & Join
														</button>
														</form>
													}
													else
													{
														<span class="badge bg-success">
															<i class="bi bi-check-circle-fill"></i> Joined
														</span>
													}
													<a asp-controller="Events"
														asp-action="Details"
														asp-route-id="@message.RelatedEventId"
														class="btn btn-outline-@(isCurrentUser ? "light" : "info") btn-sm"
														target="_blank">
														<i class="bi bi-eye"></i> View Event
													</a>
												</div>
											}
											else if(isEventInvitation && isCurrentUser)
											{
												@*For sender, just show view link*@
												<div class="mt-2">
													<a asp-controller="Events"
													   asp-action="Details"
													   asp-route-id="@message.RelatedEventId"
													   class="btn btn-outline-light btn-sm"
													   target="_blank">
														<i class="bi bi-eye"></i> View Event
													</a>
												</div>
											}
											else
											{
												@*Regular event-related message(not invitation*@
												<div class="mt-2">
													<a asp-controller="Events"
													   asp-action="Details"
													   asp-route-id="@message.RelatedEventId"
													   class="@(isCurrentUser ? "text-white" : "text-primary")">
													   View Event Details <i class="bi bi-arrow-right"></i>
													</a>
												</div>
											}
										</div>
									}
									<div class="mt-2 text-end">
										<small class="@(isCurrentUser ? "text-white-50" : "text-muted")">
											@message.SentAt.ToString("MMM dd, yyyy h:mm tt")
											@if (message.IsRead && isCurrentUser)
											{
												<i class="bi bi-check2-all"></i>
											}
										</small>
									</div>
								</div>
							</div>
						}
					}
				</div>
			</div>

			<!--quick reply form-->
			@if (otherParticipant != null && conversationId.HasValue)
			{
				<div class="card mt-3">
					<div class="card-body">
						<form id="quickReplyForm">
							@Html.AntiForgeryToken()
							<input type="hidden" id="conversationId" value="@conversationId" />
							<div class="mb-3">
								<label for="quickReplyContent" class="form-label">Quick Reply</label>
								<textarea class="form-control"
											id="quickReplyContent"
											name="content"
											rows="3"
											placeholder="Type your reply here..."
											required></textarea>
							</div>
							<button type="submit" class="btn btn-primary">
								<i class="bi bi-send"></i> Send Reply
							</button>
						</form>
						<div id="replyStatus" class="mt-2"></div>
					</div>
				</div>
			}
		</div>
	</div>
</div>

@section Scripts{
	<script>
		//scroll to bottom of messages
		document.addEventListener('DOMContentLoaded', function(){
			var messageContainer = document.getElementById('messageContainer');
			if(messageContainer){
				messageContainer.scrollTop = messageContainer.scrollHeight;
			}
		});

		//quick reply form submission
		document.getElementById('quickReplyForm')?.addEventListener('submit', async function(e){
			e.preventDefault();

			const content = document.getElementById('quickReplyContent').value;
			const conversationId = document.getElementById('conversationId').value;
			const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
			const statusDiv = document.getElementById('replyStatus');

			try{
				const response = await fetch('@Url.Action("SendQuickReply", "Messages")',{
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'RequestVerificationToken': token
					},
					body: JSON.stringify({
						conversationId: conversationId,
						content: content,
						messageType: 'direct'
					})
				});
				const result = await response.json();

				if(result.success){
					statusDiv.innerHTML = '<div class="alert alert-success">Message sent! Refreshing...</div>';
					setTimeout(()=>location.reload(), 1000);
				} else{
					statusDiv.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
				}
			} catch(error){
				statusDiv.innerHTML = '<div class="alert alert-danger">An error occurred while sending the message.</div>';
			}
		});
	</script>
}

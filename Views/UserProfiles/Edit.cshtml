@model CS478_EventPlannerProject.Models.UserProfiles
@Html.ValidationSummary()
@{
    ViewData["Title"] = "Edit Profile";
}

<link rel="stylesheet" href="~/css/userprofile.css" />

<h2>Edit Profile</h2>

<form asp-action="Edit" enctype="multipart/form-data" method="post">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="UserProfileId" />
    <div class="form-group">
        <label for="FirstName">First Name</label>
        <input type="text" asp-for="FirstName" class="form-control" />
        <span asp-validation-for="FirstName" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label for="LastName">Last Name</label>
        <input type="text" asp-for="LastName" class="form-control" />
        <span asp-validation-for="LastName" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label for="DisplayName">Display Name</label>
        <input type="text" asp-for="DisplayName" class="form-control" />
        <span asp-validation-for="DisplayName" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label for="Bio">Bio</label>
        <textarea asp-for="Bio" class="form-control"></textarea>
        <span asp-validation-for="Bio" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label for="ProfileImageUrl">Profile Image</label>
        <input asp-for="ProfileImageFile" type="file" class="form-control" data-val="false" />
        <span asp-validation-for="ProfileImageFile" class="text-danger"></span>
        <small class="form-text text-muted">Upload a profile image (JPG, PNG, GIF)</small>
        @if (!string.IsNullOrEmpty(Model.ProfileImageUrl))
        {
            <div class="mt-2">
                <img src="@Model.ProfileImageUrl" alt="Current Profile" style="max-width: 150px; max-height: 150px; border-radius: 50%;" />
                <p class="text-muted">Current profile image</p>
            </div>
        }
    </div>

    <div class="form-group">
        <label for="Location">Location</label>
        <div class="input-group">
            <input type="text" asp-for="Location" class="form-control" id="locationInput" />
            <button type="button" class="btn btn-outline-secondary" onclick="getMyLocation()">
                <i class="bi bi-geo-alt-fill"></i> Find My Location
            </button>
        </div>
        <span asp-validation-for="Location" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label for="Website">Website</label>
        <input type="url" asp-for="Website" class="form-control" />
        <span asp-validation-for="Website" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label for="FacebookUrl">Facebook</label>
        <input type="url" asp-for="FacebookUrl" class="form-control" />
        <span asp-validation-for="FacebookUrl" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label for="TwitterUrl">Twitter</label>
        <input type="url" asp-for="TwitterUrl" class="form-control" />
        <span asp-validation-for="TwitterUrl" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label for="LinkedInUrl">LinkedIn</label>
        <input type="url" asp-for="LinkedInUrl" class="form-control" />
        <span asp-validation-for="LinkedInUrl" class="text-danger"></span>
    </div>

    <div class="form-group form-check">
        <input type="checkbox" asp-for="IsPublic" class="form-check-input" />
        <label class="form-check-label" for="IsPublic">Make profile public</label>
    </div>

    <button type="submit" class="btn btn-primary">Save Changes</button>
    <a asp-action="Profile" class="btn btn-secondary">Cancel</a>
</form>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        function getMyLocation() {
            const locationInput = document.getElementById('locationInput');

            if (!navigator.geolocation) {
                alert("Geolocation is not supported by your browser.");
                return;
            }

            // Show loading state
            locationInput.value = "Getting location...";

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    // Use OpenStreetMap's Nominatim API for reverse geocoding
                    fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`)
                        .then(response => response.json())
                        .then(data => {
                            const city = data.address.city || data.address.town || data.address.village || '';
                            const state = data.address.state || '';
                            const country = data.address.country || '';

                            // Format: "City, State" or "City, Country" depending on what's available
                            let location = '';
                            if (city && state) {
                                location = `${city}, ${state}`;
                            } else if (city && country) {
                                location = `${city}, ${country}`;
                            } else if (state) {
                                location = state;
                            } else {
                                location = country;
                            }

                            locationInput.value = location;
                        })
                        .catch(error => {
                            console.error('Error getting location name:', error);
                            locationInput.value = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                            alert('Could not get location name, but coordinates were found.');
                        });
                },
                function(error) {
                    locationInput.value = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            alert("Location access denied. Please enable location permissions in your browser.");
                            break;
                        case error.POSITION_UNAVAILABLE:
                            alert("Location information is unavailable.");
                            break;
                        case error.TIMEOUT:
                            alert("The request to get your location timed out.");
                            break;
                        default:
                            alert("An unknown error occurred.");
                            break;
                    }
                }
            );
        }
    </script>
}
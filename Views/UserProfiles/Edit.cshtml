@model CS478_EventPlannerProject.Models.UserProfiles
@Html.ValidationSummary()
@{
    ViewData["Title"] = "Edit Profile";
}

<link rel="stylesheet" href="~/css/userprofile.css" />

<h2>Edit Profile</h2>

<form asp-action="Edit" enctype="multipart/form-data" method="post">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="UserProfileId" />
    <input type="hidden" name="SelectedAvatar" id="selectedAvatarInput" value="" />

    <div class="form-group">
        <label for="FirstName">First Name</label>
        <input type="text" asp-for="FirstName" class="form-control" />
        <span asp-validation-for="FirstName" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label for="LastName">Last Name</label>
        <input type="text" asp-for="LastName" class="form-control" />
        <span asp-validation-for="LastName" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label for="DisplayName">Display Name</label>
        <input type="text" asp-for="DisplayName" class="form-control" />
        <span asp-validation-for="DisplayName" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label for="Bio">Bio</label>
        <textarea asp-for="Bio" class="form-control"></textarea>
        <span asp-validation-for="Bio" class="text-danger"></span>
    </div>

    <!-- Profile Image Section -->
    <div class="form-group">
        <label for="ProfileImageUrl">Profile Image</label>

        <!-- Current Image Preview -->
        @if (!string.IsNullOrEmpty(Model.ProfileImageUrl))
        {
            <div class="mb-3" id="currentProfileImgContainer">
                <img src="@Model.ProfileImageUrl" alt="Current Profile" id="currentProfileImg" style="max-width: 150px; max-height: 150px; border-radius: 50%; border: 3px solid #ddd;" />
                <p class="text-muted mb-0">Current profile image</p>
            </div>
        }

        <!-- Avatar Selection Section -->
        <div class="mb-3">
            <button type="button" class="btn btn-outline-primary btn-sm" id="showAvatarsBtn">
                <i class="bi bi-image"></i> Choose from Default Avatars
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm d-none" id="hideAvatarsBtn">
                <i class="bi bi-x"></i> Hide Avatars
            </button>
        </div>

        <div id="avatarGallery" class="mb-3" style="display: none;">
            <p class="text-muted mb-2">Select a default avatar:</p>
            <div id="avatarContainer" class="d-flex flex-wrap gap-2">
                <div class="text-center text-muted py-3">
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    Loading avatars...
                </div>
            </div>
        </div>

        <!-- Custom File Upload -->
        <div class="mb-2">
            <input asp-for="ProfileImageFile" type="file" class="form-control" id="customFileUpload" data-val="false" accept="image/jpeg,image/jpg,image/png,image/gif" />
            <span asp-validation-for="ProfileImageFile" class="text-danger"></span>
            <small class="form-text text-muted">Upload a custom image (JPG, PNG, GIF - Max 5MB)</small>
        </div>
    </div>

    <div class="form-group">
        <label for="Location">Location</label>
        <div class="input-group">
            <input type="text" asp-for="Location" class="form-control" id="locationInput" />
            <button type="button" class="btn btn-outline-secondary" onclick="getMyLocation()">
                <i class="bi bi-geo-alt-fill"></i> Find My Location
            </button>
        </div>
        <span asp-validation-for="Location" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label for="Website">Website</label>
        <input type="url" asp-for="Website" class="form-control" />
        <span asp-validation-for="Website" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label for="FacebookUrl">Facebook</label>
        <input type="url" asp-for="FacebookUrl" class="form-control" />
        <span asp-validation-for="FacebookUrl" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label for="TwitterUrl">Twitter</label>
        <input type="url" asp-for="TwitterUrl" class="form-control" />
        <span asp-validation-for="TwitterUrl" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label for="LinkedInUrl">LinkedIn</label>
        <input type="url" asp-for="LinkedInUrl" class="form-control" />
        <span asp-validation-for="LinkedInUrl" class="text-danger"></span>
    </div>

    <div class="form-group form-check">
        <input type="checkbox" asp-for="IsPublic" class="form-check-input" />
        <label class="form-check-label" for="IsPublic">Make profile public</label>
    </div>

    <button type="submit" class="btn btn-primary">Save Changes</button>
    <a asp-action="Profile" class="btn btn-secondary">Cancel</a>
</form>

<script>
    let avatarsLoaded = false;
    let selectedAvatarPath = '';

    // Show/Hide Avatar Gallery
    const showBtn = document.getElementById('showAvatarsBtn');
    const hideBtn = document.getElementById('hideAvatarsBtn');
    const gallery = document.getElementById('avatarGallery');

    showBtn?.addEventListener('click', () => {
        gallery.style.display = 'block';
        showBtn.classList.add('d-none');
        hideBtn.classList.remove('d-none');
        if (!avatarsLoaded) loadAvatars();
    });

    hideBtn?.addEventListener('click', () => {
        gallery.style.display = 'none';
        hideBtn.classList.add('d-none');
        showBtn.classList.remove('d-none');
    });

    function loadAvatars() {
        fetch('/UserProfiles/GetAvailableAvatars')
            .then(res => res.ok ? res.json() : Promise.reject('Failed to load avatars'))
            .then(avatars => {
                const container = document.getElementById('avatarContainer');
                if (!avatars || avatars.length === 0) {
                    container.innerHTML = '<p class="text-muted">No default avatars available.</p>';
                    avatarsLoaded = true;
                    return;
                }
                container.innerHTML = '';
                avatars.forEach(path => {
                    const img = document.createElement('img');
                    img.src = path;
                    img.alt = 'Avatar option';
                    img.className = 'avatar-option';
                    img.dataset.avatarPath = path;

                    // Preselect current image if matches
                    const currentImg = document.getElementById('currentProfileImg');
                    if (currentImg && currentImg.src.endsWith(path)) {
                        img.classList.add('selected');
                        selectedAvatarPath = path;
                        document.getElementById('selectedAvatarInput').value = path;
                    }

                    img.addEventListener('click', () => {
                        document.querySelectorAll('.avatar-option').forEach(a => a.classList.remove('selected'));
                        img.classList.add('selected');
                        selectedAvatarPath = path;
                        document.getElementById('selectedAvatarInput').value = path;

                        // Clear custom upload
                        const uploadInput = document.getElementById('customFileUpload');
                        if (uploadInput) uploadInput.value = '';

                        // Update preview
                        const previewImg = document.getElementById('currentProfileImg');
                        if (previewImg) previewImg.src = path;
                    });

                    container.appendChild(img);
                });
                avatarsLoaded = true;
            })
            .catch(err => {
                console.error('Error loading avatars:', err);
                document.getElementById('avatarContainer').innerHTML = '<p class="text-danger">Error loading avatars.</p>';
            });
    }

    // Handle custom file upload
    const fileUpload = document.getElementById('customFileUpload');
    fileUpload?.addEventListener('change', function () {
        if (this.files.length === 0) return;

        const file = this.files[0];
        const allowed = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
        const maxSize = 5 * 1024 * 1024; // 5MB

        if (!allowed.includes(file.type.toLowerCase())) {
            alert('Invalid file type. Use JPG, PNG, or GIF.');
            this.value = '';
            return;
        }

        if (file.size > maxSize) {
            alert('File too large. Max 5MB.');
            this.value = '';
            return;
        }

        // Clear avatar selection
        selectedAvatarPath = '';
        document.getElementById('selectedAvatarInput').value = '';
        document.querySelectorAll('.avatar-option').forEach(a => a.classList.remove('selected'));

        // Show preview
        const reader = new FileReader();
        reader.onload = function (e) {
            const previewImg = document.getElementById('currentProfileImg');
            if (previewImg) previewImg.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });

    // Location button function
    function getMyLocation() {
        const locationInput = document.getElementById('locationInput');
        if (!navigator.geolocation) return alert('Geolocation not supported.');

        locationInput.value = 'Getting location...';
        navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`)
                .then(res => res.json())
                .then(data => {
                    const city = data.address.city || data.address.town || data.address.village || '';
                    const state = data.address.state || '';
                    const country = data.address.country || '';
                    locationInput.value = city && state ? `${city}, ${state}` : city && country ? `${city}, ${country}` : state || country || '';
                });
        }, err => alert('Unable to retrieve location.'));
    }
</script>
